---
- name: Reporte de Informaciรณn del Servidor - AlmaLinux 9
  hosts: all
  gather_facts: yes
  become: yes
  
  vars:
    report_separator: "================================================================"
  
  tasks:
    - name: Obtener versiรณn detallada del sistema operativo
      shell: |
        cat /etc/os-release | grep -E "PRETTY_NAME|VERSION_ID" | cut -d'"' -f2 | paste -sd " - "
      register: os_version
      changed_when: false
    
    - name: Obtener informaciรณn del kernel
      shell: uname -r
      register: kernel_version
      changed_when: false
    
    - name: Verificar Apache (httpd) - versiรณn
      shell: |
        if rpm -q httpd &>/dev/null; then
          rpm -q httpd --queryformat '%{VERSION}-%{RELEASE}'
        else
          echo "no_instalado"
        fi
      register: apache_rpm_version
      changed_when: false
    
    - name: Verificar Apache (httpd) - estado del servicio
      shell: |
        if systemctl list-unit-files | grep -q "^httpd.service"; then
          systemctl is-active httpd
        else
          echo "no_instalado"
        fi
      register: apache_service_status
      changed_when: false
      failed_when: false
    
    - name: Verificar Apache (httpd) - enabled/disabled
      shell: |
        if systemctl list-unit-files | grep -q "^httpd.service"; then
          systemctl is-enabled httpd 2>/dev/null || echo "disabled"
        else
          echo "no_instalado"
        fi
      register: apache_enabled
      changed_when: false
      failed_when: false
    
    - name: Obtener versiรณn del binario de Apache
      shell: /usr/sbin/httpd -v | head -n 1 | awk '{print $3}'
      register: apache_binary_version
      changed_when: false
      when: apache_rpm_version.stdout != "no_instalado"
      failed_when: false
    
    - name: Verificar Nginx - versiรณn
      shell: |
        if rpm -q nginx &>/dev/null; then
          rpm -q nginx --queryformat '%{VERSION}-%{RELEASE}'
        else
          echo "no_instalado"
        fi
      register: nginx_rpm_version
      changed_when: false
    
    - name: Verificar Nginx - estado del servicio
      shell: |
        if systemctl list-unit-files | grep -q "^nginx.service"; then
          systemctl is-active nginx
        else
          echo "no_instalado"
        fi
      register: nginx_service_status
      changed_when: false
      failed_when: false
    
    - name: Verificar Nginx - enabled/disabled
      shell: |
        if systemctl list-unit-files | grep -q "^nginx.service"; then
          systemctl is-enabled nginx 2>/dev/null || echo "disabled"
        else
          echo "no_instalado"
        fi
      register: nginx_enabled
      changed_when: false
      failed_when: false
    
    - name: Obtener hostname completo
      shell: hostnamectl --static
      register: hostname_output
      changed_when: false
    
    - name: Obtener FQDN
      shell: hostname -f
      register: fqdn_output
      changed_when: false
      failed_when: false
    
    - name: Obtener todas las interfaces de red con IPs
      shell: |
        ip -4 addr show | awk '/inet/ {print $NF": "$2}' | column -t
      register: all_ips
      changed_when: false
    
    - name: Obtener gateway predeterminado
      shell: ip route | grep default | awk '{print $3}'
      register: default_gateway
      changed_when: false
    
    - name: Obtener configuraciรณn DNS
      shell: grep -v "^#" /etc/resolv.conf | grep nameserver | awk '{print $2}' | paste -sd ", "
      register: dns_servers
      changed_when: false
    
    - name: Obtener dominios de Apache - Virtual Hosts
      shell: |
        if [ -f /etc/httpd/conf/httpd.conf ]; then
          grep -E "^\s*(ServerName|ServerAlias)" /etc/httpd/conf/httpd.conf /etc/httpd/conf.d/*.conf 2>/dev/null | \
          awk '{print $2}' | grep -v "^$" | sort -u
        else
          echo "sin_configurar"
        fi
      register: apache_domains
      changed_when: false
      when: apache_rpm_version.stdout != "no_instalado"
      failed_when: false
    
    - name: Obtener puertos de escucha de Apache
      shell: |
        if systemctl is-active httpd &>/dev/null; then
          ss -tlnp | grep httpd | awk '{print $4}' | cut -d: -f2 | sort -u | paste -sd ", "
        else
          echo "servicio_inactivo"
        fi
      register: apache_ports
      changed_when: false
      when: apache_rpm_version.stdout != "no_instalado"
      failed_when: false
    
    - name: Obtener dominios de Nginx - Server Blocks
      shell: |
        if [ -d /etc/nginx ]; then
          grep -rh "^\s*server_name" /etc/nginx/conf.d/*.conf /etc/nginx/nginx.conf 2>/dev/null | \
          awk '{for(i=2;i<=NF;i++) print $i}' | tr -d ';' | grep -v "^$" | grep -v "localhost" | sort -u
        else
          echo "sin_configurar"
        fi
      register: nginx_domains
      changed_when: false
      when: nginx_rpm_version.stdout != "no_instalado"
      failed_when: false
    
    - name: Obtener puertos de escucha de Nginx
      shell: |
        if systemctl is-active nginx &>/dev/null; then
          ss -tlnp | grep nginx | awk '{print $4}' | cut -d: -f2 | sort -u | paste -sd ", "
        else
          echo "servicio_inactivo"
        fi
      register: nginx_ports
      changed_when: false
      when: nginx_rpm_version.stdout != "no_instalado"
      failed_when: false
    
    - name: Obtener uso de memoria
      shell: free -h | awk 'NR==2{printf "Total: %s | Usado: %s | Libre: %s | Disponible: %s", $2, $3, $4, $7}'
      register: memory_info
      changed_when: false
    
    - name: Obtener uso de disco
      shell: df -h / | awk 'NR==2{printf "Total: %s | Usado: %s (%s) | Disponible: %s", $2, $3, $5, $4}'
      register: disk_info
      changed_when: false
    
    - name: Obtener tiempo de actividad
      shell: uptime -p
      register: uptime_info
      changed_when: false
    
    - name: Obtener carga del sistema
      shell: uptime | awk -F'load average:' '{print $2}' | xargs
      register: load_average
      changed_when: false
    
    - name: Generar reporte consolidado
      debug:
        msg: |
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ                REPORTE DE SERVIDOR - ALMALINUX 9                       โ
          โ                   Generado: {{ ansible_date_time.date }} {{ ansible_date_time.time }}                        โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐ INFORMACIรN DEL SISTEMA                                            โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
            โข Sistema Operativo : {{ os_version.stdout }}
            โข Kernel            : {{ kernel_version.stdout }}
            โข Arquitectura      : {{ ansible_architecture }}
            โข Tiempo activo     : {{ uptime_info.stdout }}
            โข Carga promedio    : {{ load_average.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐ฅ๏ธ  IDENTIFICACIรN DEL SERVIDOR                                       โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
            โข Hostname          : {{ hostname_output.stdout }}
            โข FQDN              : {{ fqdn_output.stdout | default('No configurado', true) }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐ CONFIGURACIรN DE RED                                               โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
            โข IP Principal      : {{ ansible_default_ipv4.address }}
            โข Interfaz          : {{ ansible_default_ipv4.interface }}
            โข Gateway           : {{ default_gateway.stdout }}
            โข Servidores DNS    : {{ dns_servers.stdout | default('No configurados', true) }}
          
            Todas las IPs configuradas:
          {{ all_ips.stdout_lines | map('regex_replace', '^', '      ') | join('\n') }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐ SERVIDORES WEB INSTALADOS                                          โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {% if apache_rpm_version.stdout != "no_instalado" %}
            โโ APACHE (HTTPD) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ Versiรณn RPM       : {{ apache_rpm_version.stdout }}
            โ Versiรณn Binario   : {{ apache_binary_version.stdout | default('N/A', true) }}
            โ Estado Servicio   : {{ apache_service_status.stdout | upper }}
            โ Inicio Automรกtico : {{ apache_enabled.stdout | upper }}
            โ Puertos Escucha   : {{ apache_ports.stdout | default('N/A', true) }}
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% else %}
            โโ APACHE (HTTPD) โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ Estado            : โ NO INSTALADO
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% endif %}
          
          {% if nginx_rpm_version.stdout != "no_instalado" %}
            โโ NGINX โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ Versiรณn RPM       : {{ nginx_rpm_version.stdout }}
            โ Estado Servicio   : {{ nginx_service_status.stdout | upper }}
            โ Inicio Automรกtico : {{ nginx_enabled.stdout | upper }}
            โ Puertos Escucha   : {{ nginx_ports.stdout | default('N/A', true) }}
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% else %}
            โโ NGINX โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ Estado            : โ NO INSTALADO
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% endif %}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐ DOMINIOS Y VIRTUAL HOSTS CONFIGURADOS                              โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
          {% if apache_rpm_version.stdout != "no_instalado" %}
            โโ DOMINIOS EN APACHE โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% if apache_domains is defined and apache_domains.stdout_lines | length > 0 and apache_domains.stdout != "sin_configurar" %}
          {% for domain in apache_domains.stdout_lines %}
            โ   โข {{ domain }}
          {% endfor %}
          {% else %}
            โ   โ๏ธ  Sin dominios configurados
          {% endif %}
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% endif %}
          
          {% if nginx_rpm_version.stdout != "no_instalado" %}
            โโ DOMINIOS EN NGINX โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% if nginx_domains is defined and nginx_domains.stdout_lines | length > 0 and nginx_domains.stdout != "sin_configurar" %}
          {% for domain in nginx_domains.stdout_lines %}
            โ   โข {{ domain }}
          {% endfor %}
          {% else %}
            โ   โ๏ธ  Sin dominios configurados
          {% endif %}
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          {% endif %}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ ๐พ RECURSOS DEL SISTEMA                                               โ
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
            โข Memoria RAM       : {{ memory_info.stdout }}
            โข Disco /           : {{ disk_info.stdout }}
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          
                            Reporte generado por AWX/Ansible
          
          โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
