---
- name: Inventario preciso por host -> CSV/JSON en AWX
  hosts: all
  gather_facts: no
  become: yes

  vars:
    reporte_json_remote: "/tmp/servidor-{{ inventory_hostname }}.json"
    reporte_csv_remote:  "/tmp/servidor-{{ inventory_hostname }}.csv"
    awx_inventarios_dir: "/var/lib/awx/projects/inventarios"   # ruta elegida (Opción A)
    md_timeout: 2

  pre_tasks:
    - name: Crear directorio temporal en host
      file:
        path: "/tmp/inventario_tmp_{{ inventory_hostname }}"
        state: directory
        mode: '0755'

    # crear ruta en controlador AWX (delegate_to localhost)
    - name: Crear carpeta destino en controlador AWX (si no existe)
      file:
        path: "{{ awx_inventarios_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: false

  tasks:
    ####################################################################
    # A) IDENTIDAD
    ####################################################################
    - name: Obtener hostname
      command: hostname
      register: hostname_out
      changed_when: false

    - name: Obtener FQDN (si aplica)
      command: hostname -f
      register: fqdn_out
      failed_when: false
      changed_when: false

    - name: Obtener OS (NAME + VERSION)
      shell: |
        if [ -f /etc/os-release ]; then
          . /etc/os-release
          printf "%s %s" "${NAME:-}" "${VERSION_ID:-}"
        else
          uname -s
        fi
      register: os_out
      changed_when: false
      failed_when: false

    - name: Obtener kernel
      command: uname -r
      register: kernel_out
      changed_when: false

    ####################################################################
    # B) RED
    ####################################################################
    - name: Obtener IP privada
      command: hostname -I
      register: ip_priv_out
      failed_when: false
      changed_when: false

    - name: Obtener IP pública (puede fallar)
      command: curl -s --max-time 5 https://ipv4.icanhazip.com || true
      register: ip_pub_out
      failed_when: false
      changed_when: false

    - name: Interfaces - listar nombres (shell seguro)
      shell: |
        ip -o link show | awk -F": " '{print $2}'
      register: interfaces_out
      failed_when: false
      changed_when: false

    - name: Puertos escuchando (ss -tulnp)
      command: ss -tulnp
      register: ports_out
      failed_when: false
      changed_when: false

    ####################################################################
    # C) HARDWARE
    ####################################################################
    - name: vCPU (nproc)
      command: nproc
      register: cpu_out
      failed_when: false
      changed_when: false

    - name: RAM total (MB)
      command: free -m | awk '/Mem:/ {print $2}'
      register: ram_mb_out
      failed_when: false
      changed_when: false

    - name: Calcular RAM en GB (seguro)
      set_fact:
        ram_gb: >-
          {% if (ram_mb_out.stdout | default('')) | length > 0 %}
            {{ ((ram_mb_out.stdout | int) / 1024) | round(2) }}
          {% else %}
            ""
          {% endif %}

    - name: Discos (lsblk JSON)
      command: lsblk -b -o NAME,SIZE,TYPE,MOUNTPOINT -J
      register: lsblk_out
      failed_when: false
      changed_when: false

    - name: Calcular disco total (suma heurística TYPE==disk) en GB
      set_fact:
        disco_total_gb: >-
          {% set total = 0 %}
          {% for line in lsblk_out.stdout_lines | default([]) %}
            {% set s = line.split() %}
            {% if s|length >= 2 %}
              {% set val = s[1] %}
              {% if val.isdigit() %}
                {% set total = total + (val | int) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {% if total > 0 %}
            {{ (total / 1024 / 1024 / 1024) | round(2) }}
          {% else %}
            ""
          {% endif %}

    ####################################################################
    # D) NUBE / PROVEEDOR
    ####################################################################
    - name: Intentar leer AWS instance-id
      uri:
        url: http://169.254.169.254/latest/meta-data/instance-id
        return_content: yes
        timeout: "{{ md_timeout }}"
      register: aws_id
      failed_when: false
      changed_when: false

    - name: Intentar leer AWS identity doc (region)
      uri:
        url: http://169.254.169.254/latest/dynamic/instance-identity/document
        return_content: yes
        timeout: "{{ md_timeout }}"
      register: aws_identity
      failed_when: false
      changed_when: false

    - name: Intentar leer GCP zone
      uri:
        url: http://metadata.google.internal/computeMetadata/v1/instance/zone
        headers:
          Metadata-Flavor: Google
        return_content: yes
        timeout: "{{ md_timeout }}"
      register: gcp_zone
      failed_when: false
      changed_when: false

    - name: Intentar leer Azure compute metadata
      uri:
        url: "http://169.254.169.254/metadata/instance/compute?api-version=2021-02-01"
        headers:
          Metadata: "true"
        return_content: yes
        timeout: "{{ md_timeout }}"
      register: azure_compute
      failed_when: false
      changed_when: false

    - name: Determinar proveedor nube y datos (seguro)
      set_fact:
        cloud_provider: >-
          {% if aws_id.content is defined and aws_id.content | trim != '' %}
            aws
          {% elif gcp_zone.content is defined and gcp_zone.content | trim != '' %}
            gcp
          {% elif azure_compute.content is defined and azure_compute.content | trim != '' %}
            azure
          {% else %}
            unknown
          {% endif %}
        cloud_instance_id: >-
          {% if aws_id.content is defined and aws_id.content | trim != '' %}
            {{ aws_id.content | trim }}
          {% elif gcp_zone.content is defined and gcp_zone.content | trim != '' %}
            {{ (gcp_zone.content.split('/')[-1]) }}
          {% elif azure_compute.content is defined and azure_compute.content | trim != '' %}
            {{ (azure_compute.content | from_json).vmId if (azure_compute.content | from_json).vmId is defined else '' }}
          {% else %}
            ""
          {% endif %}
        cloud_region: >-
          {% if aws_identity.content is defined and aws_identity.content | trim != '' %}
            {{ (aws_identity.content | from_json).region if (aws_identity.content | from_json).region is defined else '' }}
          {% elif gcp_zone.content is defined and gcp_zone.content | trim != '' %}
            {{ (gcp_zone.content.split('/')[-1]) }}
          {% elif azure_compute.content is defined and azure_compute.content | trim != '' %}
            {{ (azure_compute.content | from_json).location if (azure_compute.content | from_json).location is defined else '' }}
          {% else %}
            ""
          {% endif %}

    ####################################################################
    # E) SERVICIOS / PROCESOS / PAQUETES
    ####################################################################
    - name: Servicios systemd activos (sample)
      command: systemctl list-units --type=service --state=running --no-pager --no-legend
      register: systemd_running
      failed_when: false
      changed_when: false

    - name: Procesos (ps) - formato corto
      command: ps -eo pid,comm,args --no-headers | head -n 200
      register: ps_list
      failed_when: false
      changed_when: false

    - name: Lista de paquetes (limitada a 200 líneas)
      shell: |
        if command -v rpm >/dev/null 2>&1; then rpm -qa | head -n 200;
        elif command -v dpkg >/dev/null 2>&1; then dpkg -l | head -n 200;
        else echo "no-pkg-manager";
        fi
      register: packages_list
      failed_when: false
      changed_when: false

    ####################################################################
    # F) WEB / APLICACIONES / VHOSTS / CERTS
    ####################################################################
    - name: Detectar nginx (versión)
      command: nginx -v
      register: nginx_ver
      failed_when: false
      changed_when: false

    - name: Detectar apache/httpd (versión)
      shell: |
        if command -v apachectl >/dev/null 2>&1; then apachectl -v;
        elif command -v httpd >/dev/null 2>&1; then httpd -v;
        else echo "";
        fi
      register: apache_ver
      failed_when: false
      changed_when: false

    - name: Listar vhosts (paths comunes, sample)
      shell: |
        find /etc/nginx /etc/apache2 /etc/httpd -type f -name "*.conf" -maxdepth 4 2>/dev/null | head -n 50 || true
      register: vhosts_list
      failed_when: false
      changed_when: false

    - name: Buscar primeros certificados SSL (sample)
      shell: |
        find /etc/letsencrypt /etc/ssl /etc/pki /etc/nginx -type f \( -name "*.pem" -o -name "*.crt" -o -name "*.cer" \) 2>/dev/null | head -n 5 || true
      register: certs_found
      failed_when: false
      changed_when: false

    - name: Extraer CN y fechas del primer certificado encontrado (si existe)
      shell: |
        f=$(echo "{{ certs_found.stdout | default('') }}" | head -n1)
        if [ -n "$f" ] && [ -f "$f" ]; then
          openssl x509 -in "$f" -noout -subject -startdate -enddate 2>/dev/null | sed -n '1,3p'
        else
          echo ""
        fi
      register: cert_first_info
      failed_when: false
      changed_when: false

    - name: Detectar aplicaciones (WordPress, Moodle, Laravel, Django, Node)
      shell: |
        out=""
        wp=$(find /var/www -maxdepth 5 -type f -name 'wp-config.php' 2>/dev/null | head -n1)
        if [ -n "$wp" ]; then out="${out}|wordpress:$wp"; fi
        mood=$(find /var/www -maxdepth 6 -type f -name 'config.php' 2>/dev/null | xargs -r grep -l "moodle" 2>/dev/null | head -n1)
        if [ -n "$mood" ]; then out="${out}|moodle:$mood"; fi
        lar=$(find /var/www /opt /home -maxdepth 5 -type f -name 'artisan' 2>/dev/null | head -n1)
        if [ -n "$lar" ]; then out="${out}|laravel:$lar"; fi
        dj=$(find /var/www /opt /home -maxdepth 5 -type f -name 'manage.py' 2>/dev/null | head -n1)
        if [ -n "$dj" ]; then out="${out}|django:$dj"; fi
        node=$(find /var/www /opt /home -maxdepth 5 -type f -name 'package.json' 2>/dev/null | head -n1)
        if [ -n "$node" ]; then out="${out}|node:$node"; fi
        echo "${out#|}"
      register: apps_detected
      failed_when: false
      changed_when: false

    ####################################################################
    # SALIDA: JSON por host (remoto)
    ####################################################################
    - name: Crear JSON remoto por host
      copy:
        dest: "{{ reporte_json_remote }}"
        mode: '0644'
        content: |
          {
            "inventory_hostname": "{{ inventory_hostname }}",
            "hostname": "{{ hostname_out.stdout | default('') }}",
            "fqdn": "{{ fqdn_out.stdout | default('') }}",
            "os": "{{ os_out.stdout | default('') }}",
            "kernel": "{{ kernel_out.stdout | default('') }}",
            "network": {
              "ip_privada": "{{ ip_priv_out.stdout | default('') | replace('\n',' ') }}",
              "ip_publica": "{{ ip_pub_out.stdout | default('') | replace('\n',' ') }}",
              "interfaces": "{{ interfaces_out.stdout | replace('\n',' | ') | default('') }}",
              "puertos_escuchando": "{{ ports_out.stdout | replace('\n',' | ') | default('') }}"
            },
            "hardware": {
              "vcpu": "{{ cpu_out.stdout | default('') }}",
              "ram_gb": "{{ ram_gb | default('') }}",
              "disco_total_gb": "{{ disco_total_gb | default('') }}"
            },
            "cloud": {
              "provider": "{{ cloud_provider }}",
              "instance_id": "{{ cloud_instance_id | default('') }}",
              "region": "{{ cloud_region | default('') }}"
            },
            "services": {
              "systemd_running_sample": "{{ systemd_running.stdout | replace('\n',' | ') | default('') }}",
