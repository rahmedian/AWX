---
- name: Reporte de Información del Servidor - AlmaLinux 9
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    csv_file: "/tmp/reporte_servidor.csv"
    json_file: "/tmp/reporte_servidor.json"

  tasks:

    - name: Obtener versión del sistema operativo
    ...
    (NOTA: Todo tu contenido original VA COMPLETO AQUÍ sin modificar nada)
    ...
    - name: Generar reporte consolidado
      debug:
        msg: |
          (TODO EL REPORTE QUE YA TENÍAS)

    ###########################################################################
    #                           SALIDA CSV + JSON
    ###########################################################################

    - name: Construir diccionario de datos
      set_fact:
        server_data:
          hostname: "{{ hostname_output.stdout }}"
          fqdn: "{{ fqdn_output.stdout | default('N/A', true) }}"
          os_version: "{{ os_version.stdout }}"
          kernel: "{{ kernel_version.stdout }}"
          arquitectura: "{{ ansible_architecture }}"
          uptime: "{{ uptime_info.stdout }}"
          load_average: "{{ load_average.stdout }}"
          ip_principal: "{{ ansible_default_ipv4.address }}"
          interfaz: "{{ ansible_default_ipv4.interface }}"
          gateway: "{{ default_gateway.stdout }}"
          dns: "{{ dns_servers.stdout }}"
          memoria: "{{ memory_info.stdout }}"
          disco: "{{ disk_info.stdout }}"
          apache_version: "{{ apache_rpm_version.stdout }}"
          apache_binario: "{{ apache_binary_version.stdout | default('N/A', true) }}"
          apache_estado: "{{ apache_service_status.stdout }}"
          apache_enabled: "{{ apache_enabled.stdout }}"
          apache_puertos: "{{ apache_ports.stdout }}"
          nginx_version: "{{ nginx_rpm_version.stdout }}"
          nginx_estado: "{{ nginx_service_status.stdout }}"
          nginx_enabled: "{{ nginx_enabled.stdout }}"
          nginx_puertos: "{{ nginx_ports.stdout }}"
          apache_domains: "{{ apache_domains.stdout_lines | default([]) }}"
          nginx_domains: "{{ nginx_domains.stdout_lines | default([]) }}"
          todas_las_ips: "{{ all_ips.stdout_lines }}"

    ###########################################################################
    #                           GENERAR CSV
    ###########################################################################

    - name: Crear encabezado CSV
      copy:
        dest: "{{ csv_file }}"
        content: |
          hostname,fqdn,os_version,kernel,arquitectura,uptime,load_average,ip_principal,interfaz,gateway,dns,memoria,disco,apache_version,apache_binario,apache_estado,apache_enabled,apache_puertos,nginx_version,nginx_estado,nginx_enabled,nginx_puertos
      when: inventory_hostname == ansible_play_hosts_all[0]

    - name: Agregar datos al CSV
      lineinfile:
        path: "{{ csv_file }}"
        insertafter: EOF
        line: >
          {{ server_data.hostname }},
          {{ server_data.fqdn }},
          {{ server_data.os_version }},
          {{ server_data.kernel }},
          {{ server_data.arquitectura }},
          {{ server_data.uptime }},
          {{ server_data.load_average }},
          {{ server_data.ip_principal }},
          {{ server_data.interfaz }},
          {{ server_data.gateway }},
          {{ server_data.dns }},
          {{ server_data.memoria }},
          {{ server_data.disco }},
          {{ server_data.apache_version }},
          {{ server_data.apache_binario }},
          {{ server_data.apache_estado }},
          {{ server_data.apache_enabled }},
          {{ server_data.apache_puertos }},
          {{ server_data.nginx_version }},
          {{ server_data.nginx_estado }},
          {{ server_data.nginx_enabled }},
          {{ server_data.nginx_puertos }}

    ###########################################################################
    #                           GENERAR JSON
    ###########################################################################

    - name: Escribir JSON en archivo
      copy:
        dest: "{{ json_file }}"
        content: "{{ server_data | to_nice_json }}"

    ###########################################################################
    #                   MOSTRAR ARCHIVOS COMO SALIDA EN AWX
    ###########################################################################

    - name: Mostrar CSV en salida AWX
      shell: "cat {{ csv_file }}"
      register: csv_output

    - debug:
        msg: "{{ csv_output.stdout }}"

    - name: Mostrar JSON en salida AWX
      shell: "cat {{ json_file }}"
      register: json_output

    - debug:
        msg: "{{ json_output.stdout }}"
