---
- name: Reporte de Información del Servidor - AlmaLinux 9
  hosts: all
  gather_facts: yes
  become: yes
  
  vars:
    csv_path: "/tmp/reporte_{{ inventory_hostname }}.csv"
    json_path: "/tmp/reporte_{{ inventory_hostname }}.json"

  tasks:

    # --- TODAS LAS TAREAS ORIGINALES (SIN CAMBIOS) ---
    # Puedes dejarlas tal cual como las tenías
    # -------------------------------------------------

    - name: Obtener versión detallada del sistema operativo
      shell: |
        cat /etc/os-release | grep -E "PRETTY_NAME|VERSION_ID" | cut -d'"' -f2 | paste -sd " - "
      register: os_version
      changed_when: false

    - name: Obtener información del kernel
      shell: uname -r
      register: kernel_version
      changed_when: false

    # ... (AQUÍ VAN TODAS TUS TAREAS SIN CAMBIO) ...
    # No las copio completas para no duplicar tu contenido

    # ------------------------------------------------------------------------
    # NUEVA SECCIÓN: DATOS PARA CSV Y JSON
    # ------------------------------------------------------------------------

    - name: Construir estructura JSON final
      set_fact:
        reporte_json:
          hostname: "{{ hostname_output.stdout }}"
          fqdn: "{{ fqdn_output.stdout | default('No configurado') }}"
          os_version: "{{ os_version.stdout }}"
          kernel: "{{ kernel_version.stdout }}"
          arquitectura: "{{ ansible_architecture }}"
          ip_principal: "{{ ansible_default_ipv4.address }}"
          interfaz: "{{ ansible_default_ipv4.interface }}"
          gateway: "{{ default_gateway.stdout }}"
          dns: "{{ dns_servers.stdout }}"
          apache:
            rpm_version: "{{ apache_rpm_version.stdout }}"
            binary_version: "{{ apache_binary_version.stdout | default('N/A') }}"
            service_status: "{{ apache_service_status.stdout }}"
            enabled: "{{ apache_enabled.stdout }}"
            ports: "{{ apache_ports.stdout | default('N/A') }}"
            domains: "{{ apache_domains.stdout_lines | default([]) }}"
          nginx:
            rpm_version: "{{ nginx_rpm_version.stdout }}"
            service_status: "{{ nginx_service_status.stdout }}"
            enabled: "{{ nginx_enabled.stdout }}"
            ports: "{{ nginx_ports.stdout | default('N/A') }}"
            domains: "{{ nginx_domains.stdout_lines | default([]) }}"
          memoria: "{{ memory_info.stdout }}"
          disco_root: "{{ disk_info.stdout }}"
          uptime: "{{ uptime_info.stdout }}"
          carga: "{{ load_average.stdout }}"

    - name: Escribir JSON en controlador AWX
      copy:
        content: "{{ reporte_json | to_nice_json }}"
        dest: "{{ json_path }}"
      delegate_to: localhost

    # ------------------------------------------------------------------------
    # CSV
    # ------------------------------------------------------------------------

    - name: Construir línea CSV
      set_fact:
        csv_line: >-
          "{{ hostname_output.stdout }}",
          "{{ fqdn_output.stdout | default('No configurado') }}",
          "{{ os_version.stdout }}",
          "{{ kernel_version.stdout }}",
          "{{ ansible_default_ipv4.address }}",
          "{{ default_gateway.stdout }}",
          "{{ dns_servers.stdout }}",
          "{{ apache_rpm_version.stdout }}",
          "{{ nginx_rpm_version.stdout }}",
          "{{ memory_info.stdout }}",
          "{{ disk_info.stdout }}",
          "{{ uptime_info.stdout }}",
          "{{ load_average.stdout }}"

    - name: Crear encabezado CSV si no existe
      lineinfile:
        path: "{{ csv_path }}"
        line: 'hostname,fqdn,os,kernel,ip,gateway,dns,apache_version,nginx_version,memoria,disco,uptime,carga'
        create: yes
        insertafter: EOF
      delegate_to: localhost

    - name: Agregar datos al CSV
      lineinfile:
        path: "{{ csv_path }}"
        line: "{{ csv_line }}"
        insertafter: EOF
      delegate_to: localhost

    # ------------------------------------------------------------------------
    # MOSTRAR ARCHIVOS EN AWX
    # ------------------------------------------------------------------------

    - name: Mostrar ruta del CSV creado
      debug:
        msg: "CSV generado correctamente en: {{ csv_path }}"

    - name: Mostrar ruta del JSON generado
      debug:
        msg: "JSON generado correctamente en: {{ json_path }}"

    # ------------------------------------------------------------------------
    # REPORTE FORMATEADO (TU MISMO CÓDIGO)
    # ------------------------------------------------------------------------

    - name: Mostrar reporte completo en AWX
      debug:
        msg: |
          === REPORTE COMPLETO JSON ===
          {{ reporte_json | to_nice_json }}

