---
- name: Inventario Completo Monolítico (AWX)
  hosts: all
  gather_facts: false
  become: true

  vars:
    carpeta_awx: "/var/lib/awx/projects/inventarios"
    reporte_csv: "servidor-{{ hostname_out.stdout }}.csv"
    reporte_json: "servidor-{{ hostname_out.stdout }}.json"

  ####################################################################
  # IDENTIDAD
  ####################################################################
  tasks:

    - name: Hostname
      command: hostname
      register: hostname_out

    - name: FQDN
      command: hostname -f
      register: fqdn_out

    - name: OS
      command: bash -lc "source /etc/os-release && echo $NAME $VERSION"
      register: os_out

    - name: Kernel
      command: uname -r
      register: kernel_out

  ####################################################################
  # RED
  ####################################################################

    - name: IP Privada
      command: hostname -I
      register: ip_priv_out

    - name: IP Pública
      command: curl -s https://ifconfig.me
      register: ip_pub_out

    - name: Interfaces
      command: ip -o link show | awk -F': ' '{print $2}'
      register: ifaces_out

    - name: Puertos escuchando
      command: ss -tulpn
      register: ports_out

  ####################################################################
  # HARDWARE
  ####################################################################

    - name: CPU Cores
      command: nproc
      register: cpu_out

    - name: RAM Total
      command: awk '/MemTotal/ {print $2}' /proc/meminfo
      register: ram_out

    - name: Discos
      command: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT
      register: lsblk_out

  ####################################################################
  # PROVEEDOR NUBE
  ####################################################################

    - name: Detectar AWS
      command: curl -s http://169.254.169.254/latest/meta-data/instance-id
      register: aws_id
      ignore_errors: true

    - name: Detectar AWS región
      command: curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | grep region | awk -F'"' '{print $4}'
      when: aws_id.stdout != ""
      register: aws_region
      ignore_errors: true

    - name: Detectar GCP zona
      command: curl -s -H "Metadata-Flavor: Google" http://169.254.169.254/computeMetadata/v1/instance/zone
      register: gcp_zone
      ignore_errors: true

    - name: Detectar Azure vmSize
      command: curl -s -H "Metadata:true" "http://169.254.169.254/metadata/instance/compute/vmSize?api-version=2021-02-01&format=text"
      register: azure_vmsize
      ignore_errors: true

  ####################################################################
  # SERVICIOS
  ####################################################################

    - name: Servicios activos (systemd)
      command: systemctl list-units --type=service --state=running --no-pager
      register: services_out

    - name: Procesos
      command: ps aux
      register: ps_out

    - name: Paquetes instalados
      command: rpm -qa || dpkg -l
      register: pkgs_out
      ignore_errors: true

  ####################################################################
  # WEB / APPS
  ####################################################################

    - name: Version nginx
      command: nginx -v
      register: nginx_ver
      ignore_errors: true

    - name: Version apache
      command: httpd -v
      register: apache_ver
      ignore_errors: true

    - name: VirtualHosts Apache
      command: apachectl -S
      register: vhosts_apache
      ignore_errors: true

    - name: VirtualHosts Nginx
      command: grep -R "server_name" /etc/nginx/sites-enabled/ 2>/dev/null
      register: vhosts_nginx
      ignore_errors: true

    - name: WordPress
      command: grep -R "wp-config" /var/www 2>/dev/null
      register: wp_out
      ignore_errors: true

    - name: Moodle
      command: grep -R "moodle" /var/www 2>/dev/null
      register: moodle_out
      ignore_errors: true

    - name: Laravel
      command: grep -R "artisan" /var/www 2>/dev/null
      register: laravel_out
      ignore_errors: true

    - name: Django
      command: grep -R "manage.py" /var/www 2>/dev/null
      register: django_out
      ignore_errors: true

    - name: NodeJS apps
      command: ps aux | grep node
      register: node_out
      ignore_errors: true

  ####################################################################
  # CREAR CSV COMPACTO
  ####################################################################

    - name: Crear CSV en host remoto
      copy:
        dest: "/tmp/{{ reporte_csv }}"
        content: |
          campo,valor
          hostname,{{ hostname_out.stdout }}
          fqdn,{{ fqdn_out.stdout }}
          ip_privada,"{{ ip_priv_out.stdout }}"
          ip_publica,"{{ ip_pub_out.stdout }}"
          os,"{{ os_out.stdout }}"
          kernel,{{ kernel_out.stdout }}
          cpu_cores,{{ cpu_out.stdout }}
          ram_kb,{{ ram_out.stdout }}
          discos,"{{ lsblk_out.stdout | replace('\n',' | ') }}"
          interfaces,"{{ ifaces_out.stdout | replace('\n',' | ') }}"
          puertos,"{{ ports_out.stdout | replace('\n',' | ') }}"
          aws_id,"{{ aws_id.stdout }}"
          aws_region,"{{ aws_region.stdout | default('') }}"
          gcp_zone,"{{ gcp_zone.stdout }}"
          azure_vmsize,"{{ azure_vmsize.stdout }}"
          servicios,"{{ services_out.stdout | replace('\n',' | ') }}"
          procesos,"{{ ps_out.stdout | replace('\n',' | ') }}"
          paquetes,"{{ pkgs_out.stdout | replace('\n',' | ') }}"
          nginx_ver,"{{ nginx_ver.stderr | default('') }}"
          apache_ver,"{{ apache_ver.stdout | default('') }}"
          vhosts_apache,"{{ vhosts_apache.stdout | replace('\n',' | ') }}"
          vhosts_nginx,"{{ vhosts_nginx.stdout | replace('\n',' | ') }}"
          wordpress,"{{ wp_out.stdout | replace('\n',' | ') }}"
          moodle,"{{ moodle_out.stdout | replace('\n',' | ') }}"
          laravel,"{{ laravel_out.stdout | replace('\n',' | ') }}"
          django,"{{ django_out.stdout | replace('\n',' | ') }}"
          node,"{{ node_out.stdout | replace('\n',' | ') }}"

  ####################################################################
  # CREAR JSON COMPACTO
  ####################################################################

    - name: Crear JSON en host remoto
      copy:
        dest: "/tmp/{{ reporte_json }}"
        content: |
          {
            "hostname": "{{ hostname_out.stdout }}",
            "fqdn": "{{ fqdn_out.stdout }}",
            "ip_privada": "{{ ip_priv_out.stdout }}",
            "ip_publica": "{{ ip_pub_out.stdout }}",
            "os": "{{ os_out.stdout }}",
            "kernel": "{{ kernel_out.stdout }}",
            "cpu_cores": "{{ cpu_out.stdout }}",
            "ram_kb": "{{ ram_out.stdout }}",
            "discos": "{{ lsblk_out.stdout | replace('\n',' | ') }}",
            "interfaces": "{{ ifaces_out.stdout | replace('\n',' | ') }}",
            "puertos": "{{ ports_out.stdout | replace('\n',' | ') }}",
            "aws_id": "{{ aws_id.stdout }}",
            "aws_region": "{{ aws_region.stdout | default('') }}",
            "gcp_zone": "{{ gcp_zone.stdout }}",
            "azure_vmsize": "{{ azure_vmsize.stdout }}",
            "servicios": "{{ services_out.stdout | replace('\n',' | ') }}",
            "procesos": "{{ ps_out.stdout | replace('\n',' | ') }}",
            "paquetes": "{{ pkgs_out.stdout | replace('\n',' | ') }}",
            "nginx_ver": "{{ nginx_ver.stderr | default('') }}",
            "apache_ver": "{{ apache_ver.stdout | default('') }}",
            "vhosts_apache": "{{ vhosts_apache.stdout | replace('\n',' | ') }}",
            "vhosts_nginx": "{{ vhosts_nginx.stdout | replace('\n',' | ') }}",
            "wordpress": "{{ wp_out.stdout | replace('\n',' | ') }}",
            "moodle": "{{ moodle_out.stdout | replace('\n',' | ') }}",
            "laravel": "{{ laravel_out.stdout | replace('\n',' | ') }}",
            "django": "{{ django_out.stdout | replace('\n',' | ') }}",
            "node": "{{ node_out.stdout | replace('\n',' | ') }}"
          }

  ####################################################################
  # COPIAR A CONTROLADOR AWX
  ####################################################################

    - name: Crear carpeta destino en AWX
      file:
        path: "{{ carpeta_awx }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: true

    - name: Copiar CSV al controlador AWX
      fetch:
        src: "/tmp/{{ reporte_csv }}"
        dest: "{{ carpeta_awx }}/"
        flat: yes

    - name: Copiar JSON al controlador AWX
      fetch:
        src: "/tmp/{{ reporte_json }}"
        dest: "{{ carpeta_awx }}/"
        flat: yes
