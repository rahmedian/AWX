---
- name: Inventario completo y preciso (CSV+JSON) para AWX
  hosts: all
  gather_facts: false
  become: yes

  vars:
    csv_local_path: "/runner/artifacts/csv"
    json_local_path: "/runner/artifacts/json"

  tasks:

  ####################################################################
  # A) IDENTIDAD
  ####################################################################

  - name: Obtener hostname
    command: hostname
    register: hostname_out

  - name: Obtener FQDN
    command: hostname -f
    register: fqdn_out
    failed_when: false

  - name: Obtener OS
    command: bash -c "source /etc/os-release && echo $NAME $VERSION"
    register: os_out

  - name: Obtener kernel
    command: uname -r
    register: kernel_out

  ####################################################################
  # B) RED
  ####################################################################

  - name: IP privada
    command: hostname -I
    register: ip_priv_out

  - name: IP pública
    command: curl -s https://ipv4.icanhazip.com
    register: ip_pub_out
    failed_when: false

  - name: Interfaces
    command: ip -o link show | awk -F': ' '{print $2}'
    register: interfaces_out

  - name: Puertos escuchando
    command: ss -tulnp
    register: ports_out

  ####################################################################
  # C) HARDWARE
  ####################################################################

  - name: CPU total
    command: nproc
    register: cpu_out

  - name: RAM total
    command: free -m | awk '/Mem:/ {print $2}'
    register: ram_out

  - name: Discos
    command: lsblk -o NAME,SIZE,TYPE,MOUNTPOINT -J
    register: discos_out

  ####################################################################
  # D) DETECCIÓN DE NUBE (AWS/GCP/Azure)
  ####################################################################

  - name: Comprobar AWS
    uri:
      url: http://169.254.169.254/latest/meta-data/instance-id
      return_content: yes
      timeout: 1
    register: aws_id
    failed_when: false

  - name: Comprobar GCP
    uri:
      url: http://metadata.google.internal/computeMetadata/v1/instance/zone
      headers: {"Metadata-Flavor": "Google"}
      return_content: yes
      timeout: 1
    register: gcp_zone
    failed_when: false

  - name: Comprobar Azure
    uri:
      url: http://169.254.169.254/metadata/instance?api-version=2021-02-01
      headers: {"Metadata": "true"}
      return_content: yes
      timeout: 1
    register: azure_meta
    failed_when: false

  - name: Determinar proveedor nube
    set_fact:
      cloud_vendor: >-
        {% if aws_id.content is defined and aws_id.content != '' %}
        AWS
        {% elif gcp_zone.content is defined and gcp_zone.content != '' %}
        GCP
        {% elif azure_meta.content is defined and azure_meta.content != '' %}
        Azure
        {% else %}
        On-Premise
        {% endif %}

  ####################################################################
  # E) SERVICIOS Y PAQUETES
  ####################################################################

  - name: Servicios activos systemd
    command: systemctl list-units --type=service --state=running --no-pager
    register: servicios_out

  - name: Lista de paquetes instalados
    command: bash -c "rpm -qa || dpkg -l"
    register: paquetes_out

  ####################################################################
  # F) WEB / APLICACIONES
  ####################################################################

  - name: Detectar Nginx
    command: nginx -v
    register: nginx_out
    failed_when: false

  - name: Detectar Apache
    command: httpd -v
    register: apache_out
    failed_when: false

  - name: Detectar vhosts
    shell: |
      grep -RHi "server_name" /etc/nginx/conf.d/*.conf 2>/dev/null;
      grep -RHi "ServerName" /etc/httpd/conf.d/*.conf 2>/dev/null
    register: vhosts_out
    failed_when: false

  - name: Detectar apps (WordPress, Moodle, Laravel)
    shell: |
      if grep -R "wp-config.php" /var/www 2>/dev/null; then echo "WordPress"; fi
      if grep -R "config.php" /var/www | grep moodle 2>/dev/null; then echo "Moodle"; fi
      if grep -R "artisan" /var/www 2>/dev/null; then echo "Laravel"; fi
    register: apps_out
    failed_when: false

  - name: Detectar SSL básico
    shell: |
      for crt in $(find /etc -name "*.crt" 2>/dev/null); do
        echo "===== $crt ====="
        openssl x509 -in $crt -noout -subject -dates
      done
    register: ssl_out
    failed_when: false

  ####################################################################
  # RUTAS LOCALES EN AWX
  ####################################################################

  - name: Crear ruta local CSV en AWX
    delegate_to: localhost
    file:
      path: "{{ csv_local_path }}"
      state: directory
      mode: '0755'

  - name: Crear ruta local JSON en AWX
    delegate_to: localhost
    file:
      path: "{{ json_local_path }}"
      state: directory
      mode: '0755'

  ####################################################################
  # CREAR CSV REMOTO
  ####################################################################

  - name: Crear CSV compacto
    copy:
      dest: "/tmp/{{ inventory_hostname }}.csv"
      mode: "0644"
      content: |
        hostname,fqdn,os,kernel,ip_publica,ip_privada,interfaces,puertos,cpu,ram,discos,nube,servicios,paquetes,nginx,apache,vhosts,ssl,apps
        "{{ hostname_out.stdout }}",
        "{{ fqdn_out.stdout }}",
        "{{ os_out.stdout }}",
        "{{ kernel_out.stdout }}",
        "{{ ip_pub_out.stdout }}",
        "{{ ip_priv_out.stdout }}",
        "{{ interfaces_out.stdout | replace('\n',' | ') }}",
        "{{ ports_out.stdout | replace('\n',' | ') }}",
        "{{ cpu_out.stdout }}",
        "{{ ram_out.stdout }}",
        "{{ discos_out.stdout | to_json }}",
        "{{ cloud_vendor }}",
        "{{ servicios_out.stdout | replace('\n',' | ') }}",
        "{{ paquetes_out.stdout | replace('\n',' | ') }}",
        "{{ nginx_out.stderr }}",
        "{{ apache_out.stdout }}",
        "{{ vhosts_out.stdout | replace('\n',' | ') }}",
        "{{ ssl_out.stdout | replace('\n',' | ') }}",
        "{{ apps_out.stdout | replace('\n',' | ') }}"

  - name: Copiar CSV remoto hacia AWX
    fetch:
      src: "/tmp/{{ inventory_hostname }}.csv"
      dest: "{{ csv_local_path }}/"
      flat: yes

  ####################################################################
  # CREAR JSON REMOTO
  ####################################################################

  - name: Crear JSON compacto
    copy:
      dest: "/tmp/{{ inventory_hostname }}.json"
      mode: "0644"
      content: |
        {
          "hostname": "{{ hostname_out.stdout }}",
          "fqdn": "{{ fqdn_out.stdout }}",
          "os": "{{ os_out.stdout }}",
          "kernel": "{{ kernel_out.stdout }}",
          "ip_publica": "{{ ip_pub_out.stdout }}",
          "ip_privada": "{{ ip_priv_out.stdout }}",
          "interfaces": "{{ interfaces_out.stdout }}",
          "puertos": "{{ ports_out.stdout }}",
          "cpu": "{{ cpu_out.stdout }}",
          "ram": "{{ ram_out.stdout }}",
          "discos": {{ discos_out.stdout }},
          "nube": "{{ cloud_vendor }}",
          "servicios": "{{ servicios_out.stdout }}",
          "paquetes": "{{ paquetes_out.stdout }}",
          "nginx": "{{ nginx_out.stderr }}",
          "apache": "{{ apache_out.stdout }}",
          "vhosts": "{{ vhosts_out.stdout }}",
          "ssl": "{{ ssl_out.stdout }}",
          "apps": "{{ apps_out.stdout }}"
        }

  - name: Copiar JSON remoto hacia AWX
    fetch:
      src: "/tmp/{{ inventory_hostname }}.json"
      dest: "{{ json_local_path }}/"
      flat: yes
