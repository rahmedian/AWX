---
- name: Inventario bÃ¡sico de servidores
  hosts: all
  gather_facts: yes
  become: yes

  vars:
    salida_dir: "/tmp"
    archivo_json: "inventario_basico.json"
    archivo_csv: "inventario_basico.csv"

  tasks:

    - name: Crear directorio de salida
      file:
        path: "{{ salida_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    # ----------------------------------------------------------------------
    # 1. LISTA DE IPS
    # ----------------------------------------------------------------------
    - name: Construir lista de IPs
      set_fact:
        ips_list: "{{ ansible_all_ipv4_addresses | default([]) }}"

    - name: Obtener IP primaria
      set_fact:
        primary_ip: "{{ ips_list[0] if ips_list | length > 0 else '' }}"

    # ----------------------------------------------------------------------
    # 2. DISCO TOTAL EN GB
    # ----------------------------------------------------------------------
    - name: Calcular disco total en GB (a partir de mounts)
      set_fact:
        disk_total_gb: >-
          {{
            (
              ansible_mounts
              | map(attribute='size_total')
              | select()
              | map('int')
              | sum
            ) // 1024 // 1024 // 1024
            if ansible_mounts is defined else 0
          }}

    # ----------------------------------------------------------------------
    # 3. INVENTARIO POR HOST
    # ----------------------------------------------------------------------
    - name: Construir diccionario del inventario por host
      set_fact:
        host_inventory:
          hostname: "{{ ansible_nodename | default(inventory_hostname) }}"
          fqdn: "{{ ansible_facts.fqdn | default('') }}"
          os: "{{ ansible_facts.os_family }} {{ ansible_facts.distribution }} {{ ansible_facts.distribution_version }}"
          kernel: "{{ ansible_facts.kernel }}"
          uptime_seconds: "{{ ansible_facts.uptime_seconds | default(0) }}"
          ips: "{{ ips_list }}"
          primary_ip: "{{ primary_ip }}"
          cpu_cores: "{{ ansible_facts.processor_vcpus | default(ansible_facts.cpu_cores | default(0)) }}"
          memory_mb: "{{ ansible_facts.memtotal_mb | default(0) }}"
          disk_total_gb: "{{ disk_total_gb }}"
          connection: "{{ ansible_connection | default('ssh') }}"

    # ----------------------------------------------------------------------
    # 4. CONSTRUIR INVENTARIO GLOBAL
    # ----------------------------------------------------------------------
    - name: Agregar host a lista global
      set_fact:
        inventario_global: "{{ (inventario_global | default([])) + [ host_inventory ] }}"
      run_once: false

    # ----------------------------------------------------------------------
    # 5. GUARDAR JSON (solo una vez)
    # ----------------------------------------------------------------------
    - name: Guardar inventario completo en JSON
      copy:
        dest: "{{ salida_dir }}/{{ archivo_json }}"
        content: "{{ inventario_global | to_nice_json }}"
      delegate_to: localhost
      run_once: true

    # ----------------------------------------------------------------------
    # 6. GUARDAR CSV (solo una vez)
    # ----------------------------------------------------------------------
    - name: Generar CSV
      copy:
        dest: "{{ salida_dir }}/{{ archivo_csv }}"
        content: |
          hostname,fqdn,os,kernel,uptime_seconds,primary_ip,ips,cpu_cores,memory_mb,disk_total_gb,connection
          {% for item in inventario_global %}
          {{ item.hostname }},
          {{ item.fqdn }},
          {{ item.os }},
          {{ item.kernel }},
          {{ item.uptime_seconds }},
          {{ item.primary_ip }},
          "{{ item.ips | join(' ') }}",
          {{ item.cpu_cores }},
          {{ item.memory_mb }},
          {{ item.disk_total_gb }},
          {{ item.connection }}
          {% endfor %}
      delegate_to: localhost
      run_once: true
