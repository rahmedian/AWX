---
- name: Obtener Información del Servidor
  hosts: all
  gather_facts: yes
  become: no
  
  tasks:
    - name: Mostrar separador inicial
      debug:
        msg: "=================================================="
    
    - name: 1. Obtener versión del Sistema Operativo
      debug:
        msg: |
          Sistema Operativo: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          Arquitectura: {{ ansible_architecture }}
    
    - name: 2. Verificar si Apache está instalado
      shell: |
        if command -v httpd &> /dev/null; then
          httpd -v 2>&1 | head -1
        elif command -v apache2 &> /dev/null; then
          apache2 -v 2>&1 | head -1
        else
          echo "Apache no instalado"
        fi
      register: apache_version
      changed_when: false
      ignore_errors: yes
    
    - name: 3. Verificar estado de Apache
      shell: |
        if systemctl is-active httpd &> /dev/null; then
          echo "ACTIVO"
        elif systemctl is-active apache2 &> /dev/null; then
          echo "ACTIVO"
        else
          echo "INACTIVO"
        fi
      register: apache_status
      changed_when: false
      ignore_errors: yes
    
    - name: 4. Verificar si Nginx está instalado
      shell: |
        if command -v nginx &> /dev/null; then
          nginx -v 2>&1
        else
          echo "Nginx no instalado"
        fi
      register: nginx_version
      changed_when: false
      ignore_errors: yes
    
    - name: 5. Verificar estado de Nginx
      shell: |
        if systemctl is-active nginx &> /dev/null; then
          echo "ACTIVO"
        else
          echo "INACTIVO"
        fi
      register: nginx_status
      changed_when: false
      ignore_errors: yes
    
    - name: Mostrar información del Servidor Web
      debug:
        msg: |
          === SERVIDORES WEB ===
          Apache: {{ apache_version.stdout }}
          Estado Apache: {{ apache_status.stdout }}
          
          Nginx: {{ nginx_version.stdout }}
          Estado Nginx: {{ nginx_status.stdout }}
    
    - name: 6. Obtener Hostname
      debug:
        msg: |
          Hostname: {{ ansible_hostname }}
          FQDN: {{ ansible_fqdn }}
    
    - name: 7. Obtener IPv4
      debug:
        msg: |
          IP Principal: {{ ansible_default_ipv4.address }}
          Gateway: {{ ansible_default_ipv4.gateway }}
          Interfaz: {{ ansible_default_ipv4.interface }}
    
    - name: 8. Listar todas las IPs del servidor
      debug:
        msg: "{{ ansible_all_ipv4_addresses }}"
    
    - name: 9. Obtener dominios/hosts virtuales de Apache
      shell: |
        if command -v httpd &> /dev/null; then
          httpd -S 2>/dev/null | grep -i "namevirtualhost\|port" || echo "No hay virtual hosts configurados"
        elif command -v apache2 &> /dev/null; then
          apache2ctl -S 2>/dev/null | grep -i "namevirtualhost\|port" || echo "No hay virtual hosts configurados"
        else
          echo "Apache no instalado"
        fi
      register: apache_vhosts
      changed_when: false
      ignore_errors: yes
      when: apache_version.stdout != "Apache no instalado"
    
    - name: 10. Obtener dominios/hosts virtuales de Nginx
      shell: |
        if [ -d /etc/nginx/sites-enabled ]; then
          grep -h "server_name" /etc/nginx/sites-enabled/* 2>/dev/null | awk '{print $2}' | tr -d ';' | sort -u || echo "No hay dominios configurados"
        elif [ -d /etc/nginx/conf.d ]; then
          grep -h "server_name" /etc/nginx/conf.d/*.conf 2>/dev/null | awk '{print $2}' | tr -d ';' | sort -u || echo "No hay dominios configurados"
        else
          echo "No se encontró configuración de Nginx"
        fi
      register: nginx_vhosts
      changed_when: false
      ignore_errors: yes
      when: nginx_version.stdout != "Nginx no instalado"
    
    - name: Mostrar Dominios Activos - Apache
      debug:
        msg: |
          === DOMINIOS EN APACHE ===
          {{ apache_vhosts.stdout }}
      when: apache_version.stdout != "Apache no instalado"
    
    - name: Mostrar Dominios Activos - Nginx
      debug:
        msg: |
          === DOMINIOS EN NGINX ===
          {{ nginx_vhosts.stdout }}
      when: nginx_version.stdout != "Nginx no instalado"
    
    - name: Resumen Final
      debug:
        msg: |
          ================================================
          RESUMEN DE INFORMACIÓN DEL SERVIDOR
          ================================================
          Hostname: {{ ansible_hostname }}
          SO: {{ ansible_distribution }} {{ ansible_distribution_version }}
          IP: {{ ansible_default_ipv4.address }}
          Apache: {{ apache_status.stdout }}
          Nginx: {{ nginx_status.stdout }}
          ================================================
